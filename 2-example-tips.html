<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jatos.js"></script>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/intertemporal-choice-list.js"></script> 
    <script src="survey-text.js"></script> 
    <link href="lib/element-style.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id="content-container">
        <!-- Content will be created by Javascript -->
    </div>
    <div class="navigation-block">
        <button id="nextButton">Next</button>
        <button id="confirmButton">Confirm</button>
    </div>

    <script type="module">
        // Configure the example choice question
        // Participants are required to compare a single-reward (Option A) and a two-reward sequence (Option B)
        // Option B is “£120 (front_amount) today and £40 (backend_amount) in 1 month (seq_length)"
        // If "condition"  is "front-align", Option A is delivered "today"
        // If "condtion" is "back-align", Option A is delivered in "3 months" (seq_length)

        import { rand } from "./stimuli-timeline.js";
        const participant_ID = (typeof jatos === "undefined")?9999:parseInt(jatos.workerId);
        // const sessionCond = sessionStorage.getItem("sessionCond");
        // const condition = (sessionCond === null)?"front-align":sessionCond;
        const condition = 'front-align';
        const configQuestion  = {"front_amount":120,
                                "backend_amount": 60,
                                "seq_length": "3 months",
                                "condition": condition,
                                };
        
        var data = {"task":"example"};       
        var finishTips = false; 
        var startTry = false;                   
        var frontAmount = configQuestion.front_amount;
        var backAmount = configQuestion.backend_amount;
        var seqLength = configQuestion.seq_length;
        var currentCond = configQuestion.condition;
        var lowerAmount,upperAmount;

        function loadPage() {

            // Add tips (contained in popovers) and reminders
            let addIntro = `
                <div id="maskRadioButtons"></div>
                <div id="step_0">
                    <div id='popContent_0'>${instructions_0}</div>
                    <button id="tipButton_0" class="tip-button">Continue</button>
                </div>
                `;

            let addTips = addTip(1) + addTip(2) + addTip(3) + addTip(4);
            let addTryChoice = `
                <div id='tryChoice'></div>
            `

            // Page HTML and content 
            let exampleTipsPage = intertemporalChoicePage + addIntro + addTips + addTryChoice;
            let optionBContent = intertemporalOptions(seqLength,currentCond);
            let optionAContent = sequenceContent(frontAmount,backAmount,seqLength);


            $('#content-container').html(exampleTipsPage);
            $("#intertemporalQuestionContent").html(intertemporalQuestionText);
            
            generatePriceList(optionAContent,optionBContent);
            hideRowsInitial();
            clickedConfirm = false;
            // $('input[name^="choice_"]').prop('disabled', true);

            // if(sessionCond === 'back-align'){
            //     $('#step_3').css('transform','translateX(30px)');
            //     $('#step_4').css('transform','translateX(30px)');
            //     $('#step_5').css('transform','translateX(30px)');
            // }
        };


        function addTip(tipNumber){
            // Add a tip (contained in a popover)
            let tip = `
                <div id="step_${tipNumber}">
                    <div id="triangle_${tipNumber}" class="triangle"></div>
                    <div id="popover_${tipNumber}" class="popover">
                        <div id="popContent_${tipNumber}" class="popover-content"></div>
                        <button id="tipButton_${tipNumber}" class="tip-button">Continue</button>
                    </div>
                </div>`;
           return(tip)
        }


        function checkChoices() {

            // When a choice is made, a reminder shows what the choice meaning
            var radios = $('input[name^="choice_"]');
            var checkedRadio = radios.filter(':checked');
            var choiceMeaningHTML,checkChoiceHTML;
            
            if (startTry && !clickedConfirm) {
                // If some buttons are clicked but the sub-choice has not been made
                var rowBreak = amountBreak*toggleRowNumber;
                if(currentRow < maxRowNumber){
                    upperAmount = clickedAmount + (clickedOptionType === 'A'?rowBreak:0);
                    lowerAmount = upperAmount - rowBreak;
                    choiceMeaningHTML = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,upperAmount,lowerAmount);
                } else{
                    lowerAmount = amountList[maxRowNumber];
                    upperAmount = lowerAmount + rowBreak;
                    choiceMeaningHTML = `
                        value <span style='color:#c74040;display: inline-block;'>
                            £${frontAmount} today and £${backAmount} in ${seqLength}</span> 
                        somewhere above <span style='color:#c74040;display: inline-block;'>
                            £${lowerAmount} today</span>
                        `
                }
                
                checkChoiceHTML = choiceIndicationText + choiceMeaningHTML + '.<br><br>' + changeChoiceText 
            } 
            if (startTry && clickedConfirm){
                // If all required choices are made
                var rowBreak = (currentRow <=maxRowNumber)?amountBreak:extendBreak
                upperAmount = clickedAmount + (clickedOptionType === 'A'?rowBreak:0)
                lowerAmount = upperAmount - rowBreak
                choiceMeaningHTML = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,upperAmount,lowerAmount);
                checkChoiceHTML = choiceIndicationText + choiceMeaningHTML + '.<br><br>' + finishChoiceText 
            }

            if(startTry){
                $('#tryChoice').html(checkChoiceHTML);
            }

                // if(lowerAmount < 0 || lowerAmount >= maxRowNumber*amountBreak){
                //     $('#tryChoice').css("transform","translateY(200px)");
                // } else {
                //     $('#tryChoice').css("transform","translateY(0)");
                // }
            // }
        }

        loadPage();
        showTip(0);       

        // After a click, will skip to the next tip (or show the reminder)
        $('#tipButton_0').on('click', nextTip);
        $('#tipButton_1').on('click', nextTip);
        $('#tipButton_2').on('click', nextTip);
        $('#tipButton_3').on('click', nextTip);
        $('#tipButton_4').on('click', function(){
            hideTip(4);
            $('#tryChoice').text(tryChoiceText).show();
            $('#maskRadioButtons').hide();
            hideRowsInitial();
            finishTips = true;
            startTry = true;
        });

        $('input[name^="choice_"]').on('click', checkChoices);

        $('#nextButton').on('click', function () {

            // If the sub-choice is not made, show the error message  
            if(!finishTips){
                $('#error-choicelist').html(error_tips).show();
            } else{
                returnError(error_intertemporalChoice);
            }

            if(startTry && allChoicesChecked && !clickedConfirm){
                var anotherChoiceText = unfoldRange(upperAmount,lowerAmount,seqLength,condition);
                $('#tryChoice').html(anotherChoiceText);
            }
            
            if(startTry && allChoicesChecked && clickedConfirm){
                let newData = configQuestion;
                newData["indiff_point"] = clickedAmount + (clickedOptionType === 'A'?0:amountBreak);
                data['worker_id'] = jatos.workerId;
                data["screen_width"] = window.innerWidth;
                data['url'] = jatos.urlQueryParameters;
                data["choice"] = newData;

                // sessionStorage.setItem("sessionCond", sessionCond);
                jatos.startNextComponent(data);
            }
        });
    </script>
</body>
</html>