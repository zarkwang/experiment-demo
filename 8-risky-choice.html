<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jatos.js"></script>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/intertemporal-choice-list.js"></script> 
    <script src="survey-text.js"></script> 
    <link href="lib/element-style.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id="content-container">
        <!-- Content will be created by Javascript -->
    </div>
    <div class="navigation-block">
        <div id="qNumber"></div>
        <button id="nextButton">Next</button>
    </div>

    <script type="module">

        import { lotteries,rand } from "./stimuli-timeline.js"
        const participant_ID = (typeof jatos === "undefined")?9999:parseInt(jatos.workerId);
        var currentIndex = 0; 
        var data = {'task':'risky'};
        var choiceData = [];
        var endIteration, newData, loadTime;
        var lotteryOrder = rand(lotteries.length,lotteries.length,participant_ID*888);
        var configQuestion;

        function loadPage(index) {

            configQuestion = lotteries[lotteryOrder[index]];

            let riskyOutcome = configQuestion.outcome;
            let riskyProb = configQuestion.prob;

            amountBreak = riskyOutcome/12;
            amountList = optionAmounts(0);

            let optionAContent = `get <span style=${dateColor}>Â£${riskyOutcome}</span> with a ${riskyProb} chance`;
            let optionBContent = certaintyOptions();

            $('#content-container').html(intertemporalChoicePage);
            $("#intertemporalQuestionContent").html(intertemporalQuestionText);
            
            generatePriceList(optionAContent,optionBContent);
            // $('#priceListTable td')[0].style.width = '260px';
            // $('#priceListTable td')[2].style.width = '160px';
            $('#qNumber').html('Progress: '+ Math.floor(1+index/lotteries.length) +"/"+ lotteries.length);
            loadTime = new Date().getTime();
        };
        
        $('#nextButton').on('click', function () {

            // track whether the current index reaches the max number of tasks (stimuli)
            endIteration = (currentIndex + 1) === lotteries.length;
            
            // If the sub-choice is not made, show the error message
            returnError(error_intertemporalChoice);
        
            if(allChoicesChecked){
                // If all required choices are made, record the new data
                newData = configQuestion;
                newData['present_order'] = currentIndex;
                newData["indiff_point"] = clickedAmount + (clickedOptionType === 'A'?amountBreak:0);
                newData['response_time_risky'] = new Date().getTime() - loadTime;
                choiceData.push(newData);
                
                console.log(choiceData);
                
                if (!endIteration){
                    currentIndex++;
                    loadPage(currentIndex);
                } else {
                    data['worker_id'] = jatos.workerId;
                    data['choice'] = choiceData;
                    // sessionStorage.clear();
                    jatos.startNextComponent(data);     
                }
            }
        });

        loadPage(currentIndex);
    </script>
</body>
</html>