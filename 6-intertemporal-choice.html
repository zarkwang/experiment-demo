<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jatos.js"></script>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/intertemporal-choice-list.js"></script> 
    <script src="survey-text.js"></script> 
    <link href="lib/element-style.css" rel="stylesheet" type="text/css" />
    <style data="slider-style" type="text/css"></style>
</head>
<body>
    <div id="content-container">
        <!-- Content will be created by Javascript -->
    </div>
    <div class="navigation-block">
        <button id="nextButton">Next</button>
    </div>

    <script type="module">

        import { stimuliContext,drawStimuli,loadStimuli } from "./stimuli-timeline.js";
        const participant_ID = (typeof jatos === "undefined")?9999:parseInt(jatos.workerId);
        const condition = 'front-align'
        // const sessionCond = sessionStorage.getItem("sessionCond");
        // const condition = (sessionCond === null)?"front-align":sessionCond;
        
        var currentIndex = 0; // question index
        var stimuli,pageName,pageLoadTime,firstChoiceTime; // "intertemporal-choice" or "confidence-check"
        var data = {'task':'intertemporal','group':condition}
        var choiceData = [];
        var frontAmount,backAmount,seqLength,currentCond,endIteration,newData;

        // Under each condition, randomly draw stimuli from the full stimulus list
        if (condition === 'front-align'){
            stimuli =  drawStimuli(stimuliContext.stimuli_frontAlign,
                                    stimuliContext.n);
        } else {
            stimuli =  drawStimuli(stimuliContext.stimuli_backAlign,
                                    stimuliContext.n);
        }

        // if (participant_ID % 2 == 0){
        //     stimuli = stimuliFront.concat(stimuliBack);
        // } else {
        //     stimuli = stimuliBack.concat(stimuliFront);
        // }

        // Each intertemporal choice question is followed with a confidence check question

        function loadPage(index) {

            let configQuestion = loadStimuli(stimuli,index);
            
            pageName = pageIteration[index % pageIteration.length];
            frontAmount = configQuestion.front_amount;
            backAmount = configQuestion.backend_amount;
            seqLength = configQuestion.seq_length;
            currentCond = configQuestion.condition;
            clickedConfirm = false;
            
            if(pageName === "intertemporal-choice"){

                let optionAContent = sequenceContent(frontAmount,backAmount,seqLength);
                let optionBContent = intertemporalOptions(seqLength,currentCond);

                $('#content-container').html(intertemporalChoicePage);
                $("#intertemporalQuestionContent").html(intertemporalQuestionText);
                $('#qNumber').html('('+ Math.floor(1+index/pageIteration.length) +"/"+ stimuli.length +')');
                
                generatePriceList(optionAContent,optionBContent);
                hideRowsInitial();
                
            } else if (pageName === "confidence-check"){

                // get the elements for choice meaning text
                let upperAmount = choiceData[choiceData.length-1].indiff_point;
                let lowerAmount = (upperAmount > maxRowAmount)?(upperAmount - extendBreak):(upperAmount-amountBreak);
                let choiceMeaningText = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,upperAmount,lowerAmount);
                let questionText = confidenceQuestionText + choiceMeaningText  + `?`;

                // load confidence check question HTML
                $('#content-container').html(confidenceCheckPage);
                
                // generate the confidence check question based on the choice meaning text 
                let style = document.querySelector('[data="slider-style"]');
                generateConfidenceQuestion(questionText,style);                
            }

            // record the time when page is (re-)loaded
            pageLoadTime = new Date().getTime();
        };

        
        $('#nextButton').on('click', function () {

            // track whether the current index reaches the max number of tasks (stimuli)
            endIteration = (currentIndex + 1) / pageIteration.length === stimuli.length;

            if(pageName === "intertemporal-choice"){

                // If the sub-choice is not made, show the error message
                returnError(error_intertemporalChoice);

                if(allChoicesChecked && !clickedConfirm){
                    // If all required choices are made, record the new data
                    newData = endIteration?"":loadStimuli(stimuli,currentIndex);
                    firstChoiceTime = new Date().getTime();
                }

                if(allChoicesChecked && clickedConfirm){
                    // move to the confidence check question
                    if(currentRow <=maxRowNumber){
                        newData["indiff_point"] = clickedAmount + (clickedOptionType === 'A'?amountBreak:0);
                    } else {
                        newData["indiff_point"] = clickedAmount + (clickedOptionType === 'A'?extendBreak:0);
                    }
                    newData['response_time_intertemporal_1'] = firstChoiceTime - pageLoadTime;
                    newData['response_time_intertemporal_2'] = new Date().getTime() - firstChoiceTime;
                    choiceData.push(newData);
                    currentIndex++;
                    loadPage(currentIndex);
                }

            } else if (pageName === "confidence-check"){

                let confidenceValue = parseInt($('#confidenceAnswer').html());

                // If confidence check question is not answered, show the error message
                // Otherwise, move to the next stimulus
                if(!confidenceValue){
                    $('#error-confidence').html(error_confirmCheck);
                } else {
                    choiceData[choiceData.length-1]["confidence"] = confidenceValue;
                    choiceData[choiceData.length-1]['response_time_confidence'] = new Date().getTime() - pageLoadTime;

                    console.log(choiceData);

                    if (!endIteration){
                        currentIndex++;
                        loadPage(currentIndex);
                    } else {
                        data['worker_id'] = jatos.workerId;
                        data['choice'] = choiceData;
                        jatos.startNextComponent(data);
                    }
                }
            }
        });

        loadPage(currentIndex);
    </script>
</body>
</html>