<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jatos.js"></script>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/intertemporal-choice-list.js"></script> 
    <script src="survey-text.js"></script> 
    <link href="lib/element-style.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id="content-container">
        <!-- Content will be created by Javascript -->
    </div>
    <div class="navigation-block">
        <button id="nextButton">Next</button>
        <button id="confirmButton">Confirm</button>
    </div>

    <script>

        var data = {"front_amount":120,
                    "backend_amount": 80,
                    "seq_length": "3 months",
                    "condition": "front-align"
                };

        function loadPage() {

            let addTips = addTip(1) + addTip(2) + addTip(3) + addTip(4);
            let addTryChoice = `
                <div id='tryChoice'>${tryChoiceText}</div>
            `
            let addConfirmQuestion = `
                <div id="confirmation-question"></div>
            `
            let exampleTipsPage = intertemporalChoicePage + 
                        addTips + addTryChoice + addConfirmQuestion;

            $('#content-container').html(exampleTipsPage);
            $("#intertemporalQuestionContent").html(intertemporalQuestionText);
            
            generatePriceList(data.front_amount, data.backend_amount, data.seq_length, data.condition);
            hideRowsInitial();
        };


        function addTip(tipNumber){
            let tip = `
                <div id="step_${tipNumber}">
                    <div id="triangle_${tipNumber}" class="triangle"></div>
                    <div id="popover_${tipNumber}" class="popover">
                        <div id="popContent_${tipNumber}" class="popover-content"></div>
                        <button id="tipButton_${tipNumber}" class="tip-button">Continue</button>
                    </div>
                </div>`;
           return(tip)
        }

        function addConfirmQuestion(frontAmount,backAmount,seqLength,indiffPoint){

            const choiceMeaningText = choiceMeaning(frontAmount,backAmount,seqLength,indiffPoint,'today')
            const confirmQuestion = `
                <div id='error-confirm' class='error-message'></div>
                <p>The choice you made means that you ${choiceMeaningText}. Do you confirm this choice?</p>
                <input type="radio" name="confirmation" id="confirmYes" value="yes">
                <label for="confirmYes">${confirmOptions[0]} </label><br>
                
                <input type="radio" name="confirmation" id="confirmNo" value="no">
                <label for="confirmNo">${confirmOptions[1]} </label>
                `
            return(confirmQuestion);
        }

        function checkChoices() {
            var checkboxes = $('input[name^="choice_"]');
            var checkedRadio = checkboxes.filter(':checked');
        
            if (checkedRadio.length > 0 && checkedRadio.length < checkboxes.length/2) {
                $('#tryChoice').text(anotherChoiceText);
            } else {
                $('#tryChoice').text(changeChoiceText);
            }
        }

        loadPage();
        showTip(1);        

        $('#tipButton_1').on('click', nextTip);
        $('#tipButton_2').on('click', nextTip);
        $('#tipButton_3').on('click', nextTip);
        $('#tipButton_4').on('click', function(){
            hideTip(4);
            $('#tryChoice').show()
        });
        $('input[name^="choice_"]').on('change', checkChoices);


        $('#nextButton').on('click', function () {
            let allChoicesChecked = true;

            for (let x = 0; x <= maxRowNumber; x++) {
                    const choiceChecked = $('input[name="choice_'+amountBreak*x +'"]:checked').val();
                    if (!choiceChecked) {
                        allChoicesChecked = false;
                        $('#error-intertemporal').html(error_intertemporalChoice);
                    break; 
                    } 
                }
            
            let confirmValue = $('input[name="confirmation"]:checked').val();
            if(confirmValue === 'no'){
                $('#error-confirm').html(error_redoChoice);
            }
            
            if(allChoicesChecked){
                data["indiff_point"] = parseInt($("#switchRow").html());
                
                var confirmQuestionContent = addConfirmQuestion(data.front_amount,data.backend_amount,
                                                                data.seq_length,data.indiff_point);
                
                $('#confirmation-question').html(confirmQuestionContent);
                $('#confirmButton').show();
                $('#confirmNo').on('click', function() {
                    $('input[name^="choice_"]').prop('checked', false);
                    $('#confirmButton').hide()
                });
            }
        });


        $('#confirmButton').on('click',function(){
            let confirmValue = $('input[name="confirmation"]:checked').val();
            if(!confirmValue){
                $('#error-confirm').html(error_confirmCheck);
            } else if(confirmValue === 'yes'){
                jatos.startNextComponent(data);
            }
        });  
    </script>
</body>
</html>