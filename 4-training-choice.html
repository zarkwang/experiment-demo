<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jatos.js"></script>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/intertemporal-choice-list.js"></script> 
    <script src="survey-text.js"></script> 
    <link href="lib/element-style.css" rel="stylesheet" type="text/css" />

</head>
<body>
    <div id="content-container">
        <!-- Content will be created by Javascript -->
    </div>
    <div class="navigation-block">
        <button id="nextButton">Next</button>
        <button id="confirmButton">Confirm</button>
    </div>

    <script type="module">

        import { practiceStimuli,loadStimuli,rand } from "./stimuli-timeline.js";
        const participant_ID = (typeof jatos === "undefined")?9999:parseInt(jatos.workerId);
        const condition = 'front-align';
        const stimuli = practiceStimuli[condition];
    
        var currentIndex = 0; // index for the current task (stimulus)
        var data = {"task":"train"};
        var choiceData = [];
        var frontAmount,backAmount,seqLength,currentCond,newData;
        var correctOption, wrongOption_1, wrongOption_2, optionOrder, endIteration;
        var showCheckQuestion = false;

        function loadPage(index) {

            let configQuestion = stimuli[index];

            frontAmount = configQuestion.front_amount;
            backAmount = configQuestion.backend_amount;
            seqLength = configQuestion.seq_length;
            currentCond = configQuestion.condition;

            amountList = optionAmounts(frontAmount - amountBreak);

            let addCheckQuestion = `
                <div id="comprehension-check"></div>
            `
            let practiceChoicePage = intertemporalChoicePage + addCheckQuestion;
            let optionAContent = sequenceContent(frontAmount,backAmount,seqLength);
            let optionBContent = intertemporalOptions(seqLength,currentCond);
            
            $('#content-container').html(practiceChoicePage);
            $("#intertemporalQuestionContent").html(intertemporalQuestionText);

            generatePriceList(optionAContent,optionBContent);
        };

        function addCheckQuestion(newData){

            // Add a comprehension check question
            // The question has three options: one correct, two wrong
            // wrongOption_1: all amounts in Option B + 500
            // wrongOption_2: the upper amount + 100, the range between upper and lower amounts * 2
            // If the upper amount in wrongOption_2 exceeds the max amount, change it to 0   

            let upperAmount = newData.indiff_point;
            let lowerAmount = upperAmount-amountBreak
            let wrongIndiff = (upperAmount+10 > amountList[amountList.length-1])?upperAmount-30:(upperAmount+233)
            
            correctOption = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,
                                                        upperAmount,lowerAmount);
            wrongOption_1 = choiceMeaning(frontAmount+1000,backAmount+1000,seqLength,currentCond,
                                                        upperAmount,lowerAmount);
            wrongOption_2 = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,
                                                        wrongIndiff,wrongIndiff-amountBreak*2);

            // These options are randomly ordered
            let options = [correctOption,wrongOption_1,wrongOption_2];
            
            optionOrder = rand(options.length,options.length,participant_ID*888);

            // HTML for the comprehension check question
            let comprehensionQuestion = `
                <div id='error-confirm' style='color:#11439e'></div>
                <p>${comprehensionQuestionText}</p>
    
                <input type="radio" name="comprehension" id="comprehend_1" value="${options[optionOrder[0]]}">
                <label for="comprehend_1">I ${options[optionOrder[0]]}</label><br>
                
                <input type="radio" name="comprehension" id="comprehend_2" value="${options[optionOrder[1]]}">
                <label for="comprehend_2">I ${options[optionOrder[1]]}</label><br>

                <input type="radio" name="comprehension" id="comprehend_3" value="${options[optionOrder[2]]}">
                <label for="comprehend_3">I ${options[optionOrder[2]]}</label><br>
                `
            return(comprehensionQuestion);
        }

        
        $('#nextButton').on('click', function () {

            // track whether the current index reaches the max number of tasks (stimuli)
            endIteration = (currentIndex + 1) === stimuli.length;

            // If the choice is not made, show the error message  
            returnError(error_intertemporalChoice);

            if(!showCheckQuestion && allChoicesChecked){
                // If all required choices are made, record the new data 
                newData = stimuli[currentIndex];
                newData["indiff_point"] = clickedAmount + (clickedOptionType === 'A'?amountBreak:0);

                // load the comprehension check question 
                let comprehensionCheckHTML = addCheckQuestion(newData);
                $('#comprehension-check').html(comprehensionCheckHTML);
                showCheckQuestion = true;

                // After clicking "Next", disable choice buttons so participants are not allowed to redo choices 
                $('input[name^="choice_"]').prop('disabled', true);
            }

            if(showCheckQuestion){
                let comprehensionValue = $('input[name="comprehension"]:checked').val();
                if(!comprehensionValue){
                        $('#error-confirm').html(error_confirmCheck);
                } else {
                    // whether the answer for comprehension check is correct
                    newData['correct'] = comprehensionValue === correctOption;
                    newData['comprehension_choice'] = comprehensionValue;
                    choiceData.push(newData);

                    console.log(choiceData);
                    
                    if(!endIteration){
                        currentIndex++;
                        loadPage(currentIndex);
                    } else if(endIteration){
                        data['worker_id'] = jatos.workerId;
                        data['choice'] = choiceData;
                        jatos.startNextComponent(data);
                    }
                }
            }
        });

        loadPage(currentIndex);
    </script>
</body>
</html>