<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jatos.js"></script>
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/intertemporal-choice-list.js"></script> 
    <script src="survey-text.js"></script> 
    <link href="lib/element-style.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div id="content-container">
        <!-- Content will be created by Javascript -->
    </div>
    <div class="navigation-block">
        <button id="nextButton">Next</button>
        <button id="confirmButton">Confirm</button>
    </div>

    <script>
        // Configure the example choice question
        // Participants are required to compare a single-reward (Option A) and a two-reward sequence (Option B)
        // Option B is “£120 (front_amount) today and £40 (backend_amount) in 1 month (seq_length)"
        // If "condition"  is "front-align", Option A is delivered "today"
        // If "condtion" is "back-align", Option A is delivered in "3 months" (seq_length)

        var configQuestion  = {"front_amount":120,
                            "backend_amount": 80,
                            "seq_length": "3 months",
                            "condition": "front-align"
                            };

        var frontAmount = configQuestion.front_amount;
        var backAmount = configQuestion.backend_amount;
        var seqLength = configQuestion.seq_length;
        var currentCond = configQuestion.condition;
        var indiffAmount;

        function loadPage() {

            // Add tips (contained in popovers) and reminders
            let addTips = addTip(1) + addTip(2) + addTip(3) + addTip(4);
            let addTryChoice = `
                <div id='tryChoice'>${tryChoiceText}</div>
            `

            // Page HTML and content 
            let exampleTipsPage = intertemporalChoicePage + addTips + addTryChoice;
            let optionAContent = intertemporalOptionA(seqLength,currentCond);
            let optionBContent = sequenceContent(frontAmount,backAmount,seqLength);

            $('#content-container').html(exampleTipsPage);
            $("#intertemporalQuestionContent").html(intertemporalQuestionText);
            
            generatePriceList(optionAContent,optionBContent);
            hideRowsInitial();
        };


        function addTip(tipNumber){
            // Add a tip (contained in a popover)
            let tip = `
                <div id="step_${tipNumber}">
                    <div id="triangle_${tipNumber}" class="triangle"></div>
                    <div id="popover_${tipNumber}" class="popover">
                        <div id="popContent_${tipNumber}" class="popover-content"></div>
                        <button id="tipButton_${tipNumber}" class="tip-button">Continue</button>
                    </div>
                </div>`;
           return(tip)
        }


        function checkChoices() {

            // When a choice is made, a reminder shows what the choice meaning
            let radios = $('input[name^="choice_"]');
            let checkedRadio = radios.filter(':checked');
            let lowerAmount = parseInt($("#switchRow").html()) - amountBreak;
            let upperAmount,choiceMeaningHTML,checkChoiceHTML;
            
            if (checkedRadio.length > 0 && checkedRadio.length < radios.length/2) {
                // If some buttons are clicked but the sub-choice has not been made
                upperAmount = lowerAmount + amountBreak*toggleRowNumber;
                choiceMeaningHTML = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,upperAmount,lowerAmount);
                checkChoiceHTML = choiceIndicationText + choiceMeaningHTML + '.<br><br>' + anotherChoiceText 
            } else {
                // If all required choices are made
                upperAmount = lowerAmount + amountBreak;
                choiceMeaningHTML = choiceMeaning(frontAmount,backAmount,seqLength,currentCond,upperAmount,lowerAmount);
                checkChoiceHTML = choiceIndicationText + choiceMeaningHTML + '.<br><br>' + changeChoiceText 
            }

            $('#tryChoice').html(checkChoiceHTML);

            if(lowerAmount < 0 || lowerAmount >= maxRowNumber*amountBreak){
                $('#tryChoice').css("transform","translateY(200px)");
            } else {
                $('#tryChoice').css("transform","translateY(0)");
            }
        }

        loadPage();
        showTip(1);        

        // After a click, will skip to the next tip (or show the reminder)
        $('#tipButton_1').on('click', nextTip);
        $('#tipButton_2').on('click', nextTip);
        $('#tipButton_3').on('click', nextTip);
        $('#tipButton_4').on('click', function(){
            hideTip(4);
            $('#tryChoice').show()
        });
        $('input[name^="choice_"]').on('change', checkChoices);


        $('#nextButton').on('click', function () {

            // If the sub-choice is not made, show the error message  
            let allChoicesChecked = true;
            for (let x = 0; x <= maxRowNumber; x++) {
                const choiceChecked = $('input[name="choice_'+amountBreak*x +'"]:checked').val();
                if (!choiceChecked) {
                    allChoicesChecked = false;
                    $('#error-intertemporal').html(error_intertemporalChoice);
                break; 
                } 
            }
            
            // let confirmValue = $('input[name="confirmation"]:checked').val();
            // if(confirmValue === 'no'){
            //     $('#error-confirm').html(error_redoChoice);
            // }
            
            if(allChoicesChecked){
                let newData = configQuestion;
                newData["indiff_point"] = parseInt($("#switchRow").html());

                jatos.startNextComponent(newData);
                
                // var confirmQuestionContent = addConfirmQuestion(data.front_amount,data.backend_amount,
                //                                                 data.seq_length,data.indiff_point);
                // $('#confirmation-question').html(confirmQuestionContent);
                // $('#confirmButton').show();
                // $('#confirmNo').on('click', function() {
                //     $('input[name^="choice_"]').prop('checked', false);
                //     $('#confirmButton').hide()
                // });
            }
        });

        // function addConfirmQuestion(frontAmount,backAmount,seqLength,indiffPoint){

        //     const choiceMeaningText = choiceMeaning(frontAmount,backAmount,seqLength,indiffPoint,'today')
        //     const confirmQuestion = `
        //         <div id='error-confirm' class='error-message'></div>
        //         <p>The choice you made means that you ${choiceMeaningText}. Do you confirm this choice?</p>
        //         <input type="radio" name="confirmation" id="confirmYes" value="yes">
        //         <label for="confirmYes">${confirmOptions[0]} </label><br>
                
        //         <input type="radio" name="confirmation" id="confirmNo" value="no">
        //         <label for="confirmNo">${confirmOptions[1]} </label>
        //         `
        //     return(confirmQuestion);
        // }


        // $('#confirmButton').on('click',function(){
        //     let confirmValue = $('input[name="confirmation"]:checked').val();
        //     if(!confirmValue){
        //         $('#error-confirm').html(error_confirmCheck);
        //     } else if(confirmValue === 'yes'){
        //         jatos.startNextComponent(data);
        //     }
        // });  
    </script>
</body>
</html>